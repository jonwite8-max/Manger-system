{% extends "base.html" %}
{% block content %}

<div class="max-w-full">
  <!-- ======================= -->
  <!-- ğŸ¯ Ù‚Ø³Ù… Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <!-- ======================= -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h2 class="text-3xl font-bold text-gray-900">ğŸ“¦ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª â€” <span class="text-blue-700">SOFAZI</span></h2>
      <p class="text-sm text-gray-500">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŒ Ø§Ù„ÙÙˆØªØ±Ø©ØŒ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ.</p>
    </div>

    <div class="flex items-center gap-3 flex-wrap">
      <div class="relative">
        <input id="searchInput" type="text" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©ØŒ Ø§Ù„Ù…Ù†ØªØ¬..." 
               class="pl-10 pr-4 py-2 rounded-lg border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-72">
        <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
          <i class="fa-solid fa-magnifying-glass"></i>
        </span>
      </div>

      <select id="statusFilter" class="py-2 px-3 rounded-lg border border-gray-200 bg-white text-sm">
        <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
        {% for s in statuses %}
          <option value="{{ s.name }}">{{ s.name }}</option>
        {% endfor %}
      </select>

      <a href="{{ url_for('orders', show_paid=not show_paid) }}" 
         class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-white text-sm hover:bg-gray-50 transition-colors">
        <i class="fas {% if show_paid %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
        {{ 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©' if show_paid else 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©' }}
      </a>
    </div>
    
    <div class="flex justify-center">
      <button id="btnAdd" class="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-6 py-3 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
        <i class="fa-solid fa-plus text-lg"></i> 
        <span class="font-semibold">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</span>
      </button>
    </div>
  </div>

  <!-- ======================= -->
  <!-- ğŸ“Š Ù‚Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª -->
  <!-- ======================= -->
  <div class="bg-white rounded-2xl shadow-md overflow-x-auto">
    <table class="w-full text-sm text-right">
      <thead class="bg-gray-100 border-b">
        <tr class="text-gray-700 font-medium">
          <th class="p-3">#</th>
          <th class="p-3">Ø§Ù„Ø§Ø³Ù…</th>
          <th class="p-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th class="p-3">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th>
          <th class="p-3">Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th class="p-3">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
          <th class="p-3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th class="p-3">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
          <th class="p-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th class="p-3">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th class="p-3">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
        </tr>
      </thead>
      <tbody id="ordersTable">
        {% for o in orders %}
        <tr class="border-b hover:bg-gray-50 transition shadow-sm" data-status="{{ o.status.name if o.status else '' }}">
          <td class="p-3 text-gray-700">{{ o.id }}</td>
          <td class="p-3 font-medium text-gray-900">{{ o.name }}</td>

          <td class="p-3">
            {% if o.phones and o.phones|length > 0 %}
              {% set phone = o.phones[0] %}
              <div class="relative">
                <button class="phone-btn text-blue-600 hover:text-blue-800 font-medium transition-colors" 
                        data-phone="{{ phone.number }}"
                        onclick="PhoneManager.showPhoneOptions('{{ phone.number }}', this)">
                  {{ phone.number }}
                </button>
                
                <div id="phoneOptions-{{ phone.number|replace('+', '')|replace(' ', '') }}" 
                     class="hidden absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                  <div class="p-2 space-y-1">
                    <a href="tel:{{ phone.number }}" 
                       class="flex items-center gap-3 w-full px-3 py-2 text-sm text-green-700 hover:bg-green-50 rounded-md transition-colors">
                      <i class="fas fa-phone text-green-600 text-xs"></i>
                      <span>Ø§Ù„Ø§ØªØµØ§Ù„</span>
                    </a>
                    
                    <a href="https://wa.me/{{ phone.number|replace('+', '')|replace(' ', '') }}" 
                       target="_blank"
                       class="flex items-center gap-3 w-full px-3 py-2 text-sm text-green-700 hover:bg-green-50 rounded-md transition-colors">
                      <i class="fab fa-whatsapp text-green-600 text-xs"></i>
                      <span>Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</span>
                    </a>
                    
                    <button onclick="PhoneManager.copyPhoneNumber('{{ phone.number }}')"
                            class="flex items-center gap-3 w-full px-3 py-2 text-sm text-blue-700 hover:bg-blue-50 rounded-md transition-colors">
                      <i class="fas fa-copy text-blue-600 text-xs"></i>
                      <span>Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…</span>
                    </button>
                  </div>
                </div>
              </div>
            {% else %}
              <span class="text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø±Ù‚Ø§Ù…</span>
            {% endif %}
          </td>

          <td class="p-3 text-gray-700">{{ o.wilaya }}</td>
          <td class="p-3 text-gray-700">{{ o.product }}</td>
          <td class="p-3 text-gray-800">{{ "%.2f"|format(o.paid) }}</td>
          <td class="p-3 text-gray-800">{{ "%.2f"|format(o.total) }}</td>
          <td class="p-3 {% if o.remaining > 0 %}text-red-600{% else %}text-green-600{% endif %} font-semibold">
            {{ "%.2f"|format(o.remaining) }}
          </td>

          <td class="p-3">
            {% if o.status %}
              <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold"
                    style="background: {{ o.status.color }}22; color: {{ o.status.color }}">
                {{ o.status.name }}
              </span>
            {% else %}
              <span class="inline-block px-3 py-1 rounded-full text-xs bg-gray-100 text-gray-700">Ø¨Ø¯ÙˆÙ† Ø­Ø§Ù„Ø©</span>
            {% endif %}
          </td>

          <td class="p-3 text-center">
            {% if o.note %}
              <button class="edit-note text-blue-600 hover:text-blue-800 text-sm font-bold" 
                      title="Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" 
                      data-note="{{ o.note }}"
                      onclick="NotesManager.showNotes('{{ o.note }}')">
                ğŸ“
              </button>
            {% else %}
              <span class="text-gray-400">-</span>
            {% endif %}
          </td>

          <td class="p-3 flex gap-2">
            <button class="edit-btn text-blue-600 hover:text-blue-800" 
                    title="ØªØ¹Ø¯ÙŠÙ„"
                    data-id="{{ o.id }}"
                    data-name="{{ o.name }}"
                    data-wilaya="{{ o.wilaya }}"
                    data-product="{{ o.product }}"
                    data-paid="{{ '%.2f'|format(o.paid) }}"
                    data-total="{{ '%.2f'|format(o.total) }}"
                    data-note="{{ o.note }}"
                    data-phones="{{ o.phones[0].number if o.phones else '' }}"
                    data-status="{{ o.status.id if o.status else '' }}"
                    onclick="OrderManager.editOrder(this)">
              <i class="fa-solid fa-pen-to-square text-lg"></i>
            </button>

            <button class="history-btn text-gray-600 hover:text-gray-800" 
                    title="Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª" 
                    data-id="{{ o.id }}"
                    onclick="HistoryManager.showHistory({{ o.id }})">
              <i class="fa-solid fa-clock-rotate-left text-lg"></i>
            </button>

            {% if o.remaining > 0 %}
            <button class="payment-btn text-green-600 hover:text-green-800" 
                    title="Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©" 
                    data-id="{{ o.id }}" 
                    data-remaining="{{ o.remaining }}"
                    onclick="PaymentManager.showPaymentModal({{ o.id }}, {{ o.remaining }})">
              <i class="fa-solid fa-money-bill-wave text-lg"></i>
            </button>
            {% endif %}

            <a href="{{ url_for('delete_order', id=o.id) }}"
               class="text-red-600 hover:text-red-800"
               title="Ø­Ø°Ù"
               onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©ØŸ');">
              <i class="fa-solid fa-trash text-lg"></i>
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="p-6 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨ÙŠØ§Øª Ø¨Ø¹Ø¯</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ======================= -->
<!-- ğŸ« Ù‚Ø³Ù… Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<!-- ======================= -->

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ÙŠØ© -->
<div id="orderModal" class="modal">
  <div class="modal-content w-full max-w-2xl">
    <form id="orderForm" method="POST" action="{{ url_for('add_order') }}" class="p-6 space-y-4">
      <div class="flex items-center justify-between mb-4 border-b pb-3">
        <h3 id="modalTitle" class="text-lg font-bold text-gray-900">â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <button type="button" onclick="ModalManager.hideModal('orderModal')" class="text-gray-500 hover:text-gray-800 text-xl">âœ–</button>
      </div>

      <input type="hidden" name="id" id="order_id">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ø§Ø³Ù… *</label><input name="name" id="order_name" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></div>
        <div><label class="block text-sm text-gray-700 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label><input type="tel" name="phones" id="order_phone" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="+213 XXX XX XX XX"></div>
        <div><label class="block text-sm text-gray-700 mb-1">Ø§Ù„ÙˆÙ„Ø§ÙŠØ© *</label><input name="wilaya" id="order_wilaya" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></div>
        <div><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ù…Ù†ØªØ¬ *</label><input name="product" id="order_product" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></div>
        <div><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label><input name="paid" id="order_paid" type="number" step="0.01" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" value="0"></div>
        <div><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ *</label><input name="total" id="order_total" type="number" step="0.01" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" value="0"></div>
        <div class="md:col-span-2"><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea name="note" id="order_note" rows="3" class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></textarea></div>
        <div class="md:col-span-2"><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select name="status" id="order_status" class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© --</option>
            {% for s in statuses %}<option value="{{ s.id }}">{{ s.name }}</option>{% endfor %}
          </select>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button type="button" onclick="ModalManager.hideModal('orderModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</button>
      </div>
    </form>
  </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
<div id="notesModal" class="modal">
  <div class="modal-content w-full max-w-md">
    <div class="p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-900">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</h3>
        <button type="button" onclick="ModalManager.hideModal('notesModal')" class="text-gray-500 hover:text-gray-800 text-xl">âœ–</button>
      </div>
      <div id="notesContent" class="max-h-60 overflow-y-auto"></div>
      <div class="mt-6 flex justify-end">
        <button type="button" onclick="ModalManager.hideModal('notesModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª -->
<div id="historyModal" class="modal">
  <div class="modal-content w-full max-w-4xl">
    <div class="p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-900">ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ© ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
        <button type="button" onclick="ModalManager.hideModal('historyModal')" class="text-gray-500 hover:text-gray-800 text-xl">âœ–</button>
      </div>
      
      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <h4 class="font-semibold text-gray-900 mb-3">ğŸ’° Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm" id="paymentSummary"></div>
      </div>
      
      <div id="historyContent" class="max-h-96 overflow-y-auto space-y-3"></div>
      
      <div class="mt-6 flex justify-end gap-3">
        <button type="button" onclick="ModalManager.hideModal('historyModal')" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">Ø¥ØºÙ„Ø§Ù‚</button>
        <button type="button" id="addPaymentBtn" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors" onclick="PaymentManager.showPaymentFromHistory()">Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</button>
      </div>
    </div>
  </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© -->
<div id="paymentModal" class="modal">
  <div class="modal-content w-full max-w-md">
    <div class="p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-900">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <button type="button" onclick="ModalManager.hideModal('paymentModal')" class="text-gray-500 hover:text-gray-800 text-xl">âœ–</button>
      </div>
      
      <form id="paymentForm" class="space-y-4">
        <input type="hidden" id="payment_order_id">
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div class="text-center">
            <div class="text-yellow-800 font-semibold">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div class="text-2xl font-bold text-yellow-600" id="remainingAmount">0.00 Ø¯Ø¬</div>
          </div>
        </div>
        
        <div><label class="block text-sm text-gray-700 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label><input type="number" step="0.01" id="payment_amount" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="0.00" min="0.01"></div>
        <div><label class="block text-sm text-gray-700 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ *</label><input type="date" id="payment_date" required class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" value="{{ now.strftime('%Y-%m-%d') if now else '' }}"></div>
        <div><label class="block text-sm text-gray-700 mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
          <select id="payment_method" class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
            <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
            <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
            <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
            <option value="Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
          </select>
        </div>
        <div><label class="block text-sm text-gray-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹</label><textarea id="payment_notes" rows="3" class="w-full rounded-lg border px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-200" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹..."></textarea></div>
        
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="ModalManager.hideModal('paymentModal')" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="submit" class="flex-1 px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======================= -->
<!-- âš¡ Ù‚Ø³Ù… JavaScript Ø§Ù„Ù…Ù†Ø¸Ù… -->
<!-- ======================= -->
<script>
// ğŸ“¦ Ù…ÙƒØªØ¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
const ModalManager = {
    showModal(modalId) {
        console.log('ğŸ”“ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©:', modalId);
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    },

    hideModal(modalId) {
        console.log('ğŸ”’ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©:', modalId);
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }
};

// ğŸ“ Ù…ÙƒØªØ¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ
const PhoneManager = {
    showPhoneOptions(phoneNumber, button) {
        document.querySelectorAll('[id^="phoneOptions-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
        
        const menuId = `phoneOptions-${phoneNumber.replace(/\+/g, '').replace(/ /g, '')}`;
        const menu = document.getElementById(menuId);
        
        if (menu) {
            menu.classList.toggle('hidden');
            
            setTimeout(() => {
                function closeMenu(e) {
                    if (!menu.contains(e.target) && e.target !== button) {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', closeMenu);
                    }
                }
                document.addEventListener('click', closeMenu);
            }, 100);
        }
    },

    copyPhoneNumber(phoneNumber) {
        navigator.clipboard.writeText(phoneNumber).then(() => {
            this.showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…: ' + phoneNumber);
        });
    },

    showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 left-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
};

// ğŸ“ Ù…ÙƒØªØ¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
const NotesManager = {
    showNotes(note) {
        const notesContent = document.getElementById('notesContent');
        if (note && note.trim() !== '') {
            notesContent.innerHTML = `<div class="bg-gray-50 p-4 rounded-lg"><p class="text-gray-700 leading-relaxed whitespace-pre-wrap">${note}</p></div>`;
        } else {
            notesContent.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-sticky-note text-4xl mb-3"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</p></div>';
        }
        ModalManager.showModal('notesModal');
    }
};

// âœï¸ Ù…ÙƒØªØ¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª
const OrderManager = {
    init() {
        // Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ÙŠØ©
        document.getElementById('btnAdd').addEventListener('click', () => {
            this.showAddForm();
        });
    },

    showAddForm() {
        document.getElementById('modalTitle').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©';
        document.getElementById('orderForm').action = "{{ url_for('add_order') }}";
        document.getElementById('orderForm').reset();
        document.getElementById('order_status').value = '';
        document.getElementById('order_id').value = '';
        ModalManager.showModal('orderModal');
    },

    editOrder(button) {
        const orderId = button.dataset.id;
        document.getElementById('modalTitle').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©';
        document.getElementById('orderForm').action = '/orders/edit/' + orderId;
        document.getElementById('order_id').value = orderId;
        
        document.getElementById('order_name').value = button.dataset.name || '';
        document.getElementById('order_wilaya').value = button.dataset.wilaya || '';
        document.getElementById('order_product').value = button.dataset.product || '';
        document.getElementById('order_paid').value = button.dataset.paid || '0';
        document.getElementById('order_total').value = button.dataset.total || '0';
        document.getElementById('order_note').value = button.dataset.note || '';
        document.getElementById('order_status').value = button.dataset.status || '';
        document.getElementById('order_phone').value = button.dataset.phones || '';

        ModalManager.showModal('orderModal');
    }
};

// ğŸ•’ Ù…ÙƒØªØ¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„
const HistoryManager = {
    currentOrderId: null,

    showHistory(orderId) {
        this.currentOrderId = orderId;
        this.loadOrderHistory(orderId);
        ModalManager.showModal('historyModal');
    },

    loadOrderHistory(orderId) {
        const historyContent = document.getElementById('historyContent');
        const paymentSummary = document.getElementById('paymentSummary');
        
        historyContent.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-spinner fa-spin text-2xl mb-3"></i><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p></div>';
        paymentSummary.innerHTML = '';
        
        fetch(`/orders/history/${orderId}`)
            .then(response => response.json())
            .then(data => {
                this.displayHistory(data);
            })
            .catch(error => {
                historyContent.innerHTML = `<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-triangle text-4xl mb-3"></i><p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</p></div>`;
            });
    },

    displayHistory(data) {
        const orderInfo = data.order_info;
        const history = data.history;
        const paymentSummary = document.getElementById('paymentSummary');
        const historyContent = document.getElementById('historyContent');
        const addPaymentBtn = document.getElementById('addPaymentBtn');

        paymentSummary.innerHTML = `
            <div class="text-center"><div class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div><div class="text-2xl font-bold text-green-600">${orderInfo.paid_amount.toFixed(2)} Ø¯Ø¬</div></div>
            <div class="text-center"><div class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="text-2xl font-bold text-blue-600">${orderInfo.total_amount.toFixed(2)} Ø¯Ø¬</div></div>
            <div class="text-center"><div class="text-gray-600">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div class="text-2xl font-bold ${orderInfo.remaining_amount > 0 ? 'text-red-600' : 'text-green-600'}">${orderInfo.remaining_amount.toFixed(2)} Ø¯Ø¬</div></div>
            <div class="text-center"><div class="text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©</div><div class="text-lg font-semibold ${orderInfo.is_paid ? 'text-green-600' : 'text-yellow-600'}">${orderInfo.is_paid ? 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹'}</div></div>
        `;

        if (!history || history.length === 0) {
            historyContent.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-history text-4xl mb-3"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p></div>';
            addPaymentBtn.style.display = 'none';
            return;
        }

        let historyHTML = '';
        history.forEach(record => {
            const isPayment = record.change_type.includes('Ø¯ÙØ¹Ø©');
            const bgColor = isPayment ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-200';
            const icon = isPayment ? 'ğŸ’°' : 'ğŸ“';
            
            historyHTML += `
                <div class="border rounded-lg p-4 ${bgColor}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2"><span class="text-lg">${icon}</span><span class="font-semibold ${isPayment ? 'text-green-700' : 'text-blue-700'}">${record.change_type}</span></div>
                        <span class="text-xs text-gray-500">${record.timestamp}</span>
                    </div>
                    <div class="text-sm text-gray-700">${record.details}</div>
                    ${isPayment ? '<div class="mt-2 text-xs text-green-600 font-semibold">âœ… Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©</div>' : ''}
                </div>
            `;
        });
        
        historyContent.innerHTML = historyHTML;
        addPaymentBtn.style.display = orderInfo.remaining_amount > 0 ? 'block' : 'none';
    }
};

// ğŸ’° Ù…ÙƒØªØ¨Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª
const PaymentManager = {
    currentOrderId: null,
    currentRemaining: 0,

    showPaymentModal(orderId, remainingAmount) {
        this.currentOrderId = orderId;
        this.currentRemaining = remainingAmount;
        
        document.getElementById('payment_order_id').value = orderId;
        document.getElementById('remainingAmount').textContent = remainingAmount.toFixed(2) + ' Ø¯Ø¬';
        document.getElementById('payment_amount').max = remainingAmount;
        document.getElementById('payment_amount').value = remainingAmount;
        
        ModalManager.showModal('paymentModal');
    },

    showPaymentFromHistory() {
        if (HistoryManager.currentOrderId) {
            this.showPaymentModal(HistoryManager.currentOrderId, this.currentRemaining);
        }
    },

    init() {
        document.getElementById('paymentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitPayment();
        });
    },

    submitPayment() {
        const orderId = document.getElementById('payment_order_id').value;
        const amount = document.getElementById('payment_amount').value;
        const date = document.getElementById('payment_date').value;
        const method = document.getElementById('payment_method').value;
        const notes = document.getElementById('payment_notes').value;
        
        if (!amount || amount <= 0) {
            PhoneManager.showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­', 'error');
            return;
        }
        
        if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¨Ù‚ÙŠÙ…Ø© ${amount} Ø¯Ø¬ØŸ`)) {
            const formData = new FormData();
            formData.append('amount', amount);
            formData.append('payment_date', date);
            formData.append('payment_method', method);
            formData.append('notes', notes);
            
            fetch(`/orders/payment/${orderId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    PhoneManager.showToast(data.message);
                    ModalManager.hideModal('paymentModal');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    PhoneManager.showToast(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©', 'error');
                }
            })
            .catch(error => {
                PhoneManager.showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'error');
            });
        }
    }
};

// ğŸ” Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
const SearchManager = {
    init() {
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.searchTable(e.target.value);
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            this.filterByStatus(e.target.value);
        });
    },

    searchTable(searchTerm) {
        const rows = document.querySelectorAll('#ordersTable tr');
        searchTerm = searchTerm.toLowerCase().trim();
        
        rows.forEach(row => {
            if (row.cells.length > 1) {
                const rowText = row.textContent.toLowerCase();
                row.style.display = searchTerm === '' || rowText.includes(searchTerm) ? '' : 'none';
            }
        });
    },

    filterByStatus(selectedStatus) {
        const rows = document.querySelectorAll('#ordersTable tr');
        
        rows.forEach(row => {
            if (row.cells.length > 1) {
                const statusCell = row.cells[8];
                if (statusCell) {
                    const statusText = statusCell.textContent.trim();
                    row.style.display = selectedStatus === '' || statusText === selectedStatus ? '' : 'none';
                }
            }
        });
    }
};

// ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª...');
    
    OrderManager.init();
    PaymentManager.init();
    SearchManager.init();
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            ModalManager.hideModal(event.target.id);
        }
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¨Ø§Ù„Ø²Ø± Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal.active').forEach(modal => {
                ModalManager.hideModal(modal.id);
            });
        }
    });
    
    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
});
</script>

<!-- ======================= -->
<!-- ğŸ¨ Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ -->
<!-- ======================= -->
<style>
.phone-btn {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.phone-btn:hover {
    background-color: #f3f4f6;
}

[id^="phoneOptions-"] {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
}

[id^="phoneOptions-"] a,
[id^="phoneOptions-"] button {
    border: none;
    background: none;
    text-align: right;
    width: 100%;
    cursor: pointer;
}

.modal-content {
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.form-input:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}
</style>
{% endblock %}