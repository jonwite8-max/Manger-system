{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">ğŸ’° Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø°ÙƒÙŠ</h1>
      <p class="text-gray-600 mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙˆØ§Ù„ÙŠØ¯ÙˆÙŠØ© Ù…Ø¹ Ù†Ø¸Ø§Ù… ØªØ³Ø¯ÙŠØ¯ Ø°ÙƒÙŠ</p>
    </div>
    
    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
      <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† -->
      <div class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl px-6 py-4 shadow-lg">
        <div class="text-sm font-medium">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©</div>
        <div class="text-2xl font-bold mt-1">{{ "%.2f"|format(total_debts) }} <span class="text-sm">Ø¯Ø¬</span></div>
      </div>
      
      <button onclick="showModal('addDebtModal')" class="btn-success flex items-center gap-2">
        <i class="fas fa-file-invoice-dollar"></i>
        Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† ÙŠØ¯ÙˆÙŠ
      </button>
    </div>
  </div>

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ØµØ¯Ø± -->
  <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6">
    <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="filterBySource('all')">
      <div class="text-2xl font-bold text-blue-600">{{ debts|length }}</div>
      <div class="text-sm text-gray-600 mt-1">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
    </div>
    <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="filterBySource('manual')">
      <div class="text-2xl font-bold text-purple-600">{{ manual_debts_count }}</div>
      <div class="text-sm text-gray-600 mt-1">Ø¯ÙŠÙˆÙ† ÙŠØ¯ÙˆÙŠØ©</div>
    </div>
    <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="filterBySource('expense')">
      <div class="text-2xl font-bold text-orange-600">{{ expense_debts_count }}</div>
      <div class="text-sm text-gray-600 mt-1">Ø¯ÙŠÙˆÙ† Ù…ØµØ§Ø±ÙŠÙ</div>
    </div>
    <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="filterBySource('purchase')">
      <div class="text-2xl font-bold text-green-600">{{ purchase_debts_count }}</div>
      <div class="text-sm text-gray-600 mt-1">Ø¯ÙŠÙˆÙ† Ù…Ø´ØªØ±ÙŠØ§Øª</div>
    </div>
    <div class="card p-4 text-center cursor-pointer hover:shadow-lg transition-all" onclick="filterBySource('transport')">
      <div class="text-2xl font-bold text-teal-600">{{ transport_debts_count }}</div>
      <div class="text-sm text-gray-600 mt-1">Ø¯ÙŠÙˆÙ† Ù†Ù‚Ù„</div>
    </div>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
  <div class="card p-2 mb-6">
    <div class="flex border-b overflow-x-auto">
      <a href="{{ url_for('debts', status='unpaid', source=source_type) }}" 
         class="flex-shrink-0 px-6 py-3 border-b-2 font-medium text-sm {% if debt_status == 'unpaid' %}border-red-500 text-red-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} transition-colors">
        <i class="fas fa-clock mr-2"></i>
        Ø§Ù„Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
        <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full mr-2">{{ debts|selectattr('status', 'equalto', 'unpaid')|list|length }}</span>
      </a>
      <a href="{{ url_for('debts', status='paid', source=source_type) }}" 
         class="flex-shrink-0 px-6 py-3 border-b-2 font-medium text-sm {% if debt_status == 'paid' %}border-green-500 text-green-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} transition-colors">
        <i class="fas fa-check-circle mr-2"></i>
        Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">{{ debts|selectattr('status', 'equalto', 'paid')|list|length }}</span>
      </a>
      <a href="{{ url_for('debts', status='all', source=source_type) }}" 
         class="flex-shrink-0 px-6 py-3 border-b-2 font-medium text-sm {% if debt_status == 'all' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %} transition-colors">
        <i class="fas fa-list mr-2"></i>
        Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ†
        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">{{ debts|length }}</span>
      </a>
    </div>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ© -->
  <div class="card p-6 mb-6">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      <!-- Ø¨Ø­Ø« -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
        <input 
          type="text" 
          id="searchInput"
          placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„ÙˆØµÙ..."
          class="form-input"
        >
      </div>
      
      <!-- ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…ØµØ¯Ø± -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“‚ Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙŠÙ†</label>
        <select id="sourceFilter" class="form-select" onchange="filterBySource(this.value)">
          <option value="all" {% if source_type == 'all' %}selected{% endif %}>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
          <option value="manual" {% if source_type == 'manual' %}selected{% endif %}>Ø¯ÙŠÙˆÙ† ÙŠØ¯ÙˆÙŠØ©</option>
          <option value="expense" {% if source_type == 'expense' %}selected{% endif %}>Ø¯ÙŠÙˆÙ† Ù…ØµØ§Ø±ÙŠÙ</option>
          <option value="purchase" {% if source_type == 'purchase' %}selected{% endif %}>Ø¯ÙŠÙˆÙ† Ù…Ø´ØªØ±ÙŠØ§Øª</option>
          <option value="transport" {% if source_type == 'transport' %}selected{% endif %}>Ø¯ÙŠÙˆÙ† Ù†Ù‚Ù„</option>
        </select>
      </div>
      
      <!-- ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’° ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <select id="amountFilter" class="form-select">
          <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</option>
          <option value="small">Ø£Ù‚Ù„ Ù…Ù† 1000 Ø¯Ø¬</option>
          <option value="medium">Ù…Ù† 1000 Ø¥Ù„Ù‰ 5000 Ø¯Ø¬</option>
          <option value="large">Ø£ÙƒØ«Ø± Ù…Ù† 5000 Ø¯Ø¬</option>
        </select>
      </div>
      
      <!-- ØªØ±ØªÙŠØ¨ -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“Š ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨</label>
        <select id="sortSelect" class="form-select">
          <option value="newest">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
          <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
          <option value="amount_high">Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„ØºØ§Ù‹</option>
          <option value="amount_low">Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¨Ù„ØºØ§Ù‹</option>
          <option value="name">Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ø£ Ø¥Ù„Ù‰ ÙŠ</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† -->
  <div class="table-container">
    <div class="overflow-x-auto">
      <table class="w-full min-w-[1000px]">
        <thead class="table-header">
          <tr>
            <th class="p-4 text-right">#</th>
            <th class="p-4 text-right">Ø§Ù„Ù…Ø¯ÙŠÙ†</th>
            <th class="p-4 text-right">Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙŠÙ†</th>
            <th class="p-4 text-right">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</th>
            <th class="p-4 text-right">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†</th>
            <th class="p-4 text-right">Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ©</th>
            <th class="p-4 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="p-4 text-right">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
          </tr>
        </thead>
        <tbody id="debtsTable">
          {% for debt in debts %}
          <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100 debt-row 
                     {% if debt.status == 'unpaid' %}bg-red-50{% else %}bg-green-50{% endif %}"
              data-debt-id="{{ debt.id }}"
              data-source="{{ debt.source_type }}"
              data-amount="{{ debt.debt_amount }}"
              data-search="{{ debt.name }} {{ debt.phone }} {{ debt.address }} {{ debt.description }}"
              data-status="{{ debt.status }}">
            <!-- Ø§Ù„Ø±Ù‚Ù… -->
            <td class="p-4">
              <div class="font-mono text-sm text-gray-500">#{{ debt.id }}</div>
              <div class="text-xs text-gray-400 mt-1">{{ debt.recorded_by }}</div>
            </td>
            
            <!-- Ø§Ù„Ù…Ø¯ÙŠÙ† -->
            <td class="p-4">
              <div class="space-y-2">
                <div class="font-semibold text-gray-900">{{ debt.name }}</div>
                <div class="text-xs text-gray-500">Ø¨Ø¯Ø£: {{ debt.start_date.strftime('%Y-%m-%d') }}</div>
                {% if debt.payment_date %}
                <div class="text-xs text-green-500">Ø¯ÙØ¹: {{ debt.payment_date.strftime('%Y-%m-%d') }}</div>
                {% endif %}
              </div>
            </td>
            
            <!-- Ù…ØµØ¯Ø± Ø§Ù„Ø¯ÙŠÙ† -->
            <td class="p-4">
              {% if debt.source_type == 'manual' %}
                <span class="badge badge-purple">Ø¯ÙŠÙ† ÙŠØ¯ÙˆÙŠ</span>
              {% elif debt.source_type == 'expense' %}
                <span class="badge badge-orange">Ù…ØµØ±ÙˆÙ</span>
              {% elif debt.source_type == 'purchase' %}
                <span class="badge badge-green">Ù…Ø´ØªØ±ÙŠØ§Øª</span>
              {% elif debt.source_type == 'transport' %}
                <span class="badge badge-teal">Ù†Ù‚Ù„</span>
              {% endif %}
              <div class="text-xs text-gray-600 mt-1">{{ debt.description|truncate(30) }}</div>
            </td>
            
            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
            <td class="p-4">
              <div class="space-y-1">
                {% if debt.phone %}
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-phone"></i>
                  <a href="tel:{{ debt.phone }}" class="hover:text-blue-600">{{ debt.phone }}</a>
                </div>
                {% endif %}
                {% if debt.address %}
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-map-marker-alt"></i>
                  <span class="max-w-xs truncate">{{ debt.address }}</span>
                </div>
                {% endif %}
              </div>
            </td>
            
            <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† -->
            <td class="p-4">
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</span>
                  <span class="font-medium">{{ debt.start_date.strftime('%Y-%m-%d') }}</span>
                </div>
                {% if debt.payment_date %}
                <div class="flex justify-between">
                  <span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹:</span>
                  <span class="font-medium text-green-600">{{ debt.payment_date.strftime('%Y-%m-%d') }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between">
                  <span class="text-gray-600">Ø§Ù„Ù…Ø¯Ø©:</span>
                  <span class="font-medium">
                    {% set days = (now.date() - debt.start_date).days %}
                    {{ days }} ÙŠÙˆÙ…
                  </span>
                </div>
                {% if debt.description %}
                <div class="text-xs text-gray-500 mt-1">{{ debt.description }}</div>
                {% endif %}
              </div>
            </td>
            
            <!-- Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
            <td class="p-4">
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø§Ù†:</span>
                  <span class="font-semibold text-red-600">{{ "%.2f"|format(debt.debt_amount) }} Ø¯Ø¬</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                  <span class="font-semibold text-green-600">{{ "%.2f"|format(debt.paid_amount) }} Ø¯Ø¬</span>
                </div>
                <div class="flex justify-between border-t pt-1">
                  <span class="text-gray-600 font-medium">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                  <span class="font-bold text-orange-600">{{ "%.2f"|format(debt.remaining_amount) }} Ø¯Ø¬</span>
                </div>
              </div>
            </td>
            
            <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
            <td class="p-4">
              {% if debt.status == 'paid' %}
              <span class="badge badge-success">Ù…Ø¯ÙÙˆØ¹</span>
              {% else %}
              <span class="badge badge-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>
              {% endif %}
            </td>
            
            <!-- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª -->
            <td class="p-4">
              <div class="flex flex-col gap-2">
                <!-- Ø¯ÙØ¹ ÙƒØ§Ù…Ù„ -->
                {% if debt.status == 'unpaid' %}
                <a href="{{ url_for('pay_debt', id=debt.id) }}" 
                   onclick="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹ÙŠÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙŠÙ† ÙƒÙ…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')"
                   class="flex items-center gap-2 text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition-colors text-sm">
                  <i class="fas fa-check-circle text-xs"></i>
                  Ø¯ÙØ¹ ÙƒØ§Ù…Ù„
                </a>
                {% endif %}
                
                <!-- Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© -->
                {% if debt.status == 'unpaid' and debt.remaining_amount > 0 %}
                <button onclick="addDebtPayment({{ debt.id }}, {{ debt.remaining_amount }}, '{{ debt.name }}')" 
                        class="flex items-center gap-2 text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors text-sm">
                  <i class="fas fa-money-bill-wave text-xs"></i>
                  Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                </button>
                {% endif %}
                
                <!-- Ø­Ø°Ù -->
                <button onclick="confirmDeleteDebt({{ debt.id }})" 
                        class="flex items-center gap-2 text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors text-sm">
                  <i class="fas fa-trash text-xs"></i>
                  Ø­Ø°Ù
                </button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="p-12 text-center">
              <div class="flex flex-col items-center justify-center">
                <i class="fas fa-money-bill-wave text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-500 mb-2">
                  {% if debt_status == 'unpaid' %}
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©
                  {% elif debt_status == 'paid' %}
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø¯ÙÙˆØ¹Ø©
                  {% else %}
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø³Ø¬Ù„Ø©
                  {% endif %}
                </h3>
                <p class="text-gray-400 mb-6">
                  {% if debt_status == 'unpaid' %}
                  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø¯ÙÙˆØ¹Ø© - Ù‡Ø°Ø§ Ø±Ø§Ø¦Ø¹! ğŸ‰
                  {% else %}
                  Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¯ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
                  {% endif %}
                </p>
                <button onclick="showModal('addDebtModal')" class="btn-primary flex items-center gap-2">
                  <i class="fas fa-file-invoice-dollar"></i>
                  Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø¯ÙŠÙ†
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„ØªØ±Ù‚ÙŠÙ… -->
  <div class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
    <div class="text-sm text-gray-600">
      Ø¹Ø±Ø¶ <span id="visibleCount" class="font-semibold">{{ debts|length }}</span> Ù…Ù† Ø£ØµÙ„ <span class="font-semibold">{{ debts|length }}</span> Ø¯ÙŠÙ†
    </div>
    <div class="flex gap-2">
      <div class="text-sm text-gray-600">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="font-semibold">{{ "%.2f"|format(total_all_debts) }} Ø¯Ø¬</span> |
        Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span class="font-semibold text-green-600">{{ "%.2f"|format(total_paid) }} Ø¯Ø¬</span> |
        Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="font-semibold text-red-600">{{ "%.2f"|format(total_debts) }} Ø¯Ø¬</span>
      </div>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† -->
<div id="addDebtModal" class="modal">
  <div class="modal-content w-full max-w-2xl">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† ÙŠØ¯ÙˆÙŠ Ø¬Ø¯ÙŠØ¯</h3>
        <button onclick="hideModal('addDebtModal')" class="text-gray-400 hover:text-gray-600 text-xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form method="POST" action="{{ url_for('add_debt') }}" class="space-y-6" id="debtForm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ† -->
          <div class="space-y-4">
            <h4 class="font-semibold text-gray-900 border-b pb-2">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯ÙŠÙ†</h4>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ† *</label>
              <input type="text" name="name" required class="form-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
              <input type="tel" name="phone" class="form-input" placeholder="+213 XXX XX XX XX">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <input type="text" name="address" class="form-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø¯ÙŠÙ†">
            </div>
          </div>

          <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙŠÙ† -->
          <div class="space-y-4">
            <h4 class="font-semibold text-gray-900 border-b pb-2">ğŸ’³ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙŠÙ†</h4>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø§Ù† (Ø¯Ø¬) *</label>
              <input type="number" step="0.01" name="debt_amount" required class="form-input" placeholder="0.00" min="0" id="debtAmount" oninput="calculateRemaining()">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¯Ø¬)</label>
              <input type="number" step="0.01" name="paid_amount" class="form-input" placeholder="0.00" min="0" value="0" id="paidAmount" oninput="calculateRemaining()">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ *</label>
              <input type="date" name="start_date" required class="form-input" value="{{ now.strftime('%Y-%m-%d') if now else '' }}">
            </div>
          </div>
        </div>

        <!-- ÙˆØµÙ Ø§Ù„Ø¯ÙŠÙ† -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ÙˆØµÙ Ø§Ù„Ø¯ÙŠÙ†</label>
          <textarea name="description" class="form-input" rows="3" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¯ÙŠÙ†..."></textarea>
        </div>

        <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ -->
        <div class="bg-red-50 rounded-lg p-4 mt-4">
          <h4 class="font-semibold text-gray-900 mb-3">ğŸ§® Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
            <div class="text-center">
              <div class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø§Ù†</div>
              <div id="previewDebtAmount" class="font-semibold text-red-600">0.00 Ø¯Ø¬</div>
            </div>
            <div class="text-center">
              <div class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
              <div id="previewPaidAmount" class="font-semibold text-green-600">0.00 Ø¯Ø¬</div>
            </div>
            <div class="text-center">
              <div class="text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
              <div id="previewRemaining" class="font-bold text-orange-600 text-lg">0.00 Ø¯Ø¬</div>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-6 border-t">
          <button type="button" onclick="hideModal('addDebtModal')" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
            Ø¥Ù„ØºØ§Ø¡
          </button>
          <button type="submit" class="btn-success flex items-center gap-2">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„Ø¯ÙŠÙ†
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© -->
<div id="addDebtPaymentModal" class="modal">
  <div class="modal-content w-full max-w-md">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠÙ†</h3>
        <button onclick="hideModal('addDebtPaymentModal')" class="text-gray-400 hover:text-gray-600 text-xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="debtPaymentContent">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
      </div>
    </div>
  </div>
</div>

<script>
// ========================
// ğŸ”§ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
// ========================
let currentDebtId = null;

// ========================
// ğŸ¯ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¨Ø­Ø«
// ========================
function applyFilters() {
    const sourceFilter = document.getElementById('sourceFilter').value;
    const amountFilter = document.getElementById('amountFilter').value;
    const sortSelect = document.getElementById('sortSelect').value;
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('.debt-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let show = true;
        
        // ÙÙ„ØªØ± Ø§Ù„Ù…ØµØ¯Ø±
        if (sourceFilter !== 'all' && row.getAttribute('data-source') !== sourceFilter) {
            show = false;
        }
        
        // ÙÙ„ØªØ± Ø§Ù„Ù…Ø¨Ù„Øº
        if (amountFilter !== 'all') {
            const amount = parseFloat(row.getAttribute('data-amount'));
            if (amountFilter === 'small' && amount >= 1000) show = false;
            if (amountFilter === 'medium' && (amount < 1000 || amount > 5000)) show = false;
            if (amountFilter === 'large' && amount <= 5000) show = false;
        }
        
        // Ø§Ù„Ø¨Ø­Ø«
        if (searchText) {
            const searchData = row.getAttribute('data-search').toLowerCase();
            if (!searchData.includes(searchText)) {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    document.getElementById('visibleCount').textContent = visibleCount;
    
    // Ø§Ù„ØªØ±ØªÙŠØ¨
    sortTable(sortSelect);
}

function filterBySource(sourceType) {
    window.location.href = `{{ url_for('debts', status=debt_status) }}&source=${sourceType}`;
}

function sortTable(sortType) {
    const tbody = document.getElementById('debtsTable');
    const rows = Array.from(tbody.querySelectorAll('.debt-row:not([style*="display: none"])'));
    
    rows.sort((a, b) => {
        switch(sortType) {
            case 'newest':
                return parseInt(b.getAttribute('data-debt-id')) - parseInt(a.getAttribute('data-debt-id'));
            case 'oldest':
                return parseInt(a.getAttribute('data-debt-id')) - parseInt(b.getAttribute('data-debt-id'));
            case 'amount_high':
                return parseFloat(b.getAttribute('data-amount')) - parseFloat(a.getAttribute('data-amount'));
            case 'amount_low':
                return parseFloat(a.getAttribute('data-amount')) - parseFloat(b.getAttribute('data-amount'));
            case 'name':
                const nameA = a.querySelector('td:nth-child(2)').textContent.trim();
                const nameB = b.querySelector('td:nth-child(2)').textContent.trim();
                return nameA.localeCompare(nameB, 'ar');
            default:
                return 0;
        }
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙÙˆÙ
    rows.forEach(row => tbody.appendChild(row));
}

// ========================
// ğŸ’° Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª
// ========================
function addDebtPayment(debtId, remainingAmount, debtorName) {
    currentDebtId = debtId;
    
    const content = `
        <form id="paymentForm" class="space-y-4">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="text-center">
                    <div class="text-blue-800 font-semibold">Ø§Ù„Ù…Ø¯ÙŠÙ†: ${debtorName}</div>
                    <div class="text-blue-800 font-semibold mt-2">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¯ÙØ¹</div>
                    <div class="text-2xl font-bold text-blue-600">${remainingAmount.toFixed(2)} Ø¯Ø¬</div>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¶Ø§Ù *</label>
                <input type="number" step="0.01" name="payment_amount" required class="form-input" placeholder="0.00" max="${remainingAmount}" id="paymentAmount">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ *</label>
                <input type="date" name="payment_date" required class="form-input" value="${new Date().toISOString().split('T')[0]}">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea name="notes" class="form-input" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹..."></textarea>
            </div>
            
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="hideModal('addDebtPaymentModal')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button type="submit" class="flex-1 btn-success">
                    <i class="fas fa-check ml-2"></i>
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹
                </button>
            </div>
        </form>
    `;
    
    document.getElementById('debtPaymentContent').innerHTML = content;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmit);
    
    showModal('addDebtPaymentModal');
}

async function handlePaymentSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const paymentAmount = parseFloat(formData.get('payment_amount'));
    
    if (paymentAmount <= 0) {
        alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
        return;
    }
    
    try {
        const response = await fetch(`/debts/pay/${currentDebtId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            hideModal('addDebtPaymentModal');
            location.reload();
        } else {
            alert('Ø®Ø·Ø£: ' + data.error);
        }
    } catch (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹: ' + error.message);
    }
}

// ========================
// ğŸ—‘ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø°Ù
// ========================
async function confirmDeleteDebt(debtId) {
    if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙŠÙ†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
        return;
    }
    
    try {
        const response = await fetch(`/debts/delete/${debtId}`);
        
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
            location.reload();
        } else {
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting debt:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¯ÙŠÙ†: ' + error.message);
    }
}

// ========================
// ğŸ”§ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
// ========================
function calculateRemaining() {
    const debtAmount = parseFloat(document.getElementById('debtAmount').value) || 0;
    const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
    const remaining = debtAmount - paidAmount;
    
    document.getElementById('previewDebtAmount').textContent = debtAmount.toFixed(2) + ' Ø¯Ø¬';
    document.getElementById('previewPaidAmount').textContent = paidAmount.toFixed(2) + ' Ø¯Ø¬';
    document.getElementById('previewRemaining').textContent = remaining.toFixed(2) + ' Ø¯Ø¬';
}

function showModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function hideModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = 'auto';
}

// ========================
// ğŸ“± Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
// ========================
document.addEventListener('DOMContentLoaded', function() {
    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const today = new Date().toISOString().split('T')[0];
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    calculateRemaining();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ÙÙ„Ø§ØªØ±
    const searchInput = document.getElementById('searchInput');
    const amountFilter = document.getElementById('amountFilter');
    const sortSelect = document.getElementById('sortSelect');
    
    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (amountFilter) amountFilter.addEventListener('change', applyFilters);
    if (sortSelect) sortSelect.addEventListener('change', applyFilters);
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        hideModal(event.target.id);
    }
});

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ù„Ø²Ø± Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            hideModal(modal.id);
        });
    }
});
</script>

<style>
/* ØªØ®ØµÙŠØµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† */
.table-container {
  max-height: 600px;
  overflow-y: auto;
  border-radius: 12px;
}

.table th {
  position: sticky;
  top: 0;
  background: #f8fafc;
  z-index: 10;
  box-shadow: 0 1px 0 #e2e8f0;
}

/* Ø¨Ø§Ø¯Ø¬Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
.badge-purple {
  background: #e9d5ff;
  color: #7e22ce;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-orange {
  background: #fed7aa;
  color: #ea580c;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-teal {
  background: #99f6e4;
  color: #0d9488;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 600;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø§ÙˆØ¨ */
@media (max-width: 768px) {
  .table-container {
    font-size: 0.75rem;
  }
  
  .modal-content {
    margin: 10px;
    width: calc(100% - 20px);
  }
}
</style>
{% endblock %}